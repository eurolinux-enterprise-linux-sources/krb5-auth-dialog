From bca56dfd463692597d565da72975b0eb34313e99 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Wed, 26 Oct 2016 16:45:17 +0200
Subject: [PATCH] Avoid endlessly renewing credentials if their lifetimes are too short

https://bugzilla.redhat.com/show_bug.cgi?id=1326706
---
 src/krb5-auth-dialog.c |   17 ++++++++++++-----
 1 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/src/krb5-auth-dialog.c b/src/krb5-auth-dialog.c
index de7beba..fbf502c 100644
--- a/src/krb5-auth-dialog.c
+++ b/src/krb5-auth-dialog.c
@@ -220,12 +220,19 @@ credentials_expiring_real (KaApplet* applet)
 		krb5_copy_principal(kcontext, my_creds.client, &kprincipal);
 	}
 	creds_expiry = my_creds.times.endtime;
-	if ((krb5_timeofday(kcontext, &now) == 0) &&
-	    (now + ka_applet_get_pw_prompt_secs(applet) > my_creds.times.endtime))
-		retval = TRUE;
-
+	if (krb5_timeofday(kcontext, &now) == 0) {
+		/* If the ticket's lifetime is shorter than pw-prompt-secs,
+		 * use the half-life to avoid renewing credentials in an
+		 * endless loop */
+		if (my_creds.times.authtime + ka_applet_get_pw_prompt_secs(applet) > my_creds.times.endtime) {
+			const krb5_timestamp lifetime = my_creds.times.endtime - my_creds.times.authtime;
+			if (now + lifetime / 2 > my_creds.times.endtime)
+				retval = TRUE;
+		} else if (now + ka_applet_get_pw_prompt_secs(applet) > my_creds.times.endtime)
+			retval = TRUE;
+	}
 	/* If our creds are expiring, determine whether they are renewable */
-	if (retval && get_cred_renewable(&my_creds) && my_creds.times.renew_till > now) {
+	if (get_cred_renewable(&my_creds) && my_creds.times.renew_till > now) {
 		ka_applet_set_tgt_renewable(applet, TRUE);
 	}
 
-- 
1.7.1

